<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê´‘ì¥ í”¼ë¼ë¯¸ë“œ</title>
  <!-- í…”ë ˆê·¸ë¨ ì›¹ì•± SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #ff6b9d;
      --secondary: #a855f7;
      --accent: #00d4ff;
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
      --surface: #0a0612;
      --text: #ffffff;
      --text-muted: #9a8aaa;
    }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--surface);
      min-height: 100vh;
      color: var(--text);
      overflow: hidden;
    }
    
    /* í—¤ë” */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: rgba(10, 6, 18, 0.98);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 107, 157, 0.2);
    }
    
    .logo {
      font-size: 14px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .header-stats {
      display: flex;
      gap: 6px;
      font-size: 9px;
    }
    
    .stat-badge {
      background: rgba(255, 255, 255, 0.1);
      padding: 3px 7px;
      border-radius: 6px;
    }
    
    .stat-badge span { color: var(--primary); font-weight: 700; }
    
    /* í•„í„° ì˜ì—­ */
    .filter-section {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      background: rgba(10, 6, 18, 0.95);
      padding: 5px 8px;
      z-index: 99;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .filter-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    
    .filter-row:last-child { margin-bottom: 0; }
    
    .filter-label {
      font-size: 8px;
      color: var(--text-muted);
      padding: 2px 5px;
      min-width: 28px;
      font-weight: 600;
    }
    
    .filter-chips {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      flex: 1;
    }
    
    .filter-chip {
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 8px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .filter-chip:hover {
      background: rgba(255, 107, 157, 0.15);
      border-color: rgba(255, 107, 157, 0.3);
    }
    
    .filter-chip.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: transparent;
    }
    
    .filter-chip .count {
      background: rgba(0, 0, 0, 0.3);
      padding: 0px 3px;
      border-radius: 4px;
      font-size: 7px;
    }
    
    /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
    .map-container {
      position: fixed;
      top: 125px;
      left: 0;
      right: 0;
      bottom: 44px;
      overflow: hidden;
      cursor: grab;
      background: 
        radial-gradient(ellipse at center, rgba(255, 215, 0, 0.04) 0%, transparent 30%),
        radial-gradient(ellipse at center, rgba(255, 107, 157, 0.03) 0%, transparent 50%),
        var(--surface);
    }
    
    .map-container:active { cursor: grabbing; }
    
    .map-world {
      position: absolute;
      width: 6000px;
      height: 6000px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }
    
    /* í”¼ë¼ë¯¸ë“œ ì¸µ - ì‚¬ê°í˜• */
    .pyramid-layer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 1px dashed;
      pointer-events: none;
    }
    
    .pyramid-layer.layer-1 {
      width: 180px;
      height: 180px;
      border-color: rgba(255, 215, 0, 0.6);
      background: radial-gradient(circle, rgba(255, 215, 0, 0.15) 0%, transparent 70%);
      box-shadow: 0 0 120px rgba(255, 215, 0, 0.2);
    }
    
    .pyramid-layer.layer-2 {
      width: 500px;
      height: 500px;
      border-color: rgba(255, 215, 0, 0.3);
      opacity: 0.6;
    }
    
    .pyramid-layer.layer-3 {
      width: 950px;
      height: 950px;
      border-color: rgba(0, 212, 255, 0.25);
      opacity: 0.5;
    }
    
    .pyramid-layer.layer-4 {
      width: 1500px;
      height: 1500px;
      border-color: rgba(255, 215, 0, 0.15);
      opacity: 0.4;
    }
    
    .pyramid-layer.layer-5 {
      width: 2200px;
      height: 2200px;
      border-color: rgba(192, 192, 192, 0.1);
      opacity: 0.3;
    }
    
    .pyramid-layer.layer-6 {
      width: 3000px;
      height: 3000px;
      border-color: rgba(205, 127, 50, 0.08);
      opacity: 0.2;
    }
    
    /* ìƒì  ì¹´ë“œ - ê¸°ë³¸ */
    .shop {
      position: absolute;
      cursor: pointer;
      transition: transform 0.2s ease;
      /* z-indexëŠ” JSì—ì„œ ìˆœìœ„ë³„ë¡œ ì„¤ì • */
    }
    
    .shop:hover {
      z-index: 10000 !important;
    }
    
    .shop-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(15, 10, 25, 0.95);
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s;
      position: relative;
    }
    
    .shop:hover .shop-card {
      transform: scale(1.1);
      border-color: var(--primary);
      box-shadow: 0 10px 40px rgba(255, 107, 157, 0.5);
    }
    
    .shop-icon { line-height: 1; }
    
    .shop-name {
      font-weight: 600;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #fff;
    }
    
    .shop-score {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .shop-guilds {
      display: flex;
      gap: 1px;
      margin-top: 2px;
    }
    
    .shop-guild-icon { font-size: 8px; }
    
    /* ============================================
       ìˆœìœ„ë³„ í¬ê¸° (ê²¹ì¹¨ ë°©ì§€ - ê°„ê²© > í¬ê¸°)
       ============================================ */
    
    /* 1ìœ„: ì¹´ë“œ 120px */
    .shop.rank-1 .shop-card {
      width: 120px;
      height: 120px;
      padding: 12px;
    }
    .shop.rank-1 .shop-name { font-size: 12px; max-width: 100px; }
    .shop.rank-1 .shop-score { font-size: 11px; }
    
    /* 2~3ìœ„: ì¹´ë“œ 100px */
    .shop.rank-2-3 .shop-card {
      width: 100px;
      height: 100px;
      padding: 10px;
    }
    .shop.rank-2-3 .shop-name { font-size: 10px; max-width: 85px; }
    .shop.rank-2-3 .shop-score { font-size: 9px; }
    
    /* 4~10ìœ„: ì¹´ë“œ 85px */
    .shop.rank-4-10 .shop-card {
      width: 85px;
      height: 85px;
      padding: 8px;
    }
    .shop.rank-4-10 .shop-name { font-size: 9px; max-width: 72px; }
    .shop.rank-4-10 .shop-score { font-size: 8px; }
    
    /* 11~30ìœ„: ì¹´ë“œ 72px */
    .shop.rank-11-30 .shop-card {
      width: 72px;
      height: 72px;
      padding: 6px;
    }
    .shop.rank-11-30 .shop-name { font-size: 8px; max-width: 62px; }
    .shop.rank-11-30 .shop-score { font-size: 7px; }
    
    /* 31~100ìœ„: ì¹´ë“œ 60px */
    .shop.rank-31-100 .shop-card {
      width: 60px;
      height: 60px;
      padding: 5px;
      opacity: 0.9;
    }
    .shop.rank-31-100 .shop-name { font-size: 7px; max-width: 52px; }
    .shop.rank-31-100 .shop-score { font-size: 6px; }
    
    /* 100ìœ„+: ì¹´ë“œ 50px */
    .shop.rank-100plus .shop-card {
      width: 50px;
      height: 50px;
      padding: 4px;
      opacity: 0.75;
    }
    .shop.rank-100plus .shop-name { font-size: 6px; max-width: 44px; }
    .shop.rank-100plus .shop-score { font-size: 5px; }
    
    /* ============================================
       ë“±ê¸‰ë³„ ìƒ‰ìƒ ìŠ¤íƒ€ì¼
       ============================================ */
    
    /* VIP - ì—°ë‘ìƒ‰ ë°°ê²½ + ê³¨ë“œ í…Œë‘ë¦¬ */
    .shop.grade-vip .shop-card {
      background: linear-gradient(135deg, rgba(50, 80, 20, 0.95), rgba(30, 60, 10, 0.95));
      border: 3px solid #ffd700;
      box-shadow: 
        0 0 40px rgba(154, 205, 50, 0.4),
        0 0 60px rgba(255, 215, 0, 0.3),
        inset 0 0 20px rgba(255, 215, 0, 0.1);
    }
    
    .shop.grade-vip .shop-score { 
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    /* ë‹¤ì´ì•„ëª¬ë“œ - ì‹œì•ˆ */
    .shop.grade-diamond .shop-card {
      background: linear-gradient(135deg, rgba(0, 50, 70, 0.95), rgba(0, 30, 50, 0.95));
      border: 2px solid #00d4ff;
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
    }
    
    .shop.grade-diamond .shop-score { color: #00d4ff; }
    
    /* ê³¨ë“œ - ê¸ˆìƒ‰ */
    .shop.grade-gold .shop-card {
      background: linear-gradient(135deg, rgba(70, 55, 20, 0.95), rgba(50, 40, 15, 0.95));
      border: 2px solid #ffd700;
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.35);
    }
    
    .shop.grade-gold .shop-score { color: #ffd700; }
    
    /* ì‹¤ë²„ - ì€ìƒ‰ */
    .shop.grade-silver .shop-card {
      background: linear-gradient(135deg, rgba(60, 60, 65, 0.95), rgba(40, 40, 45, 0.95));
      border: 2px solid #c0c0c0;
      box-shadow: 0 0 20px rgba(192, 192, 192, 0.25);
    }
    
    .shop.grade-silver .shop-score { color: #c0c0c0; }
    
    /* ë¸Œë¡ ì¦ˆ - ë™ìƒ‰ */
    .shop.grade-bronze .shop-card {
      background: linear-gradient(135deg, rgba(60, 40, 25, 0.95), rgba(40, 28, 18, 0.95));
      border: 2px solid #cd7f32;
      box-shadow: 0 0 15px rgba(205, 127, 50, 0.2);
    }
    
    .shop.grade-bronze .shop-score { color: #cd7f32; }
    
    /* ìˆœìœ„ ë°°ì§€ - ë“±ê¸‰ë³„ ìƒ‰ìƒ */
    .rank-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      min-width: 22px;
      height: 22px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 800;
      padding: 0 5px;
      z-index: 2;
      border: 2px solid rgba(10, 6, 18, 0.95);
    }
    
    @keyframes vip-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
      50% { box-shadow: 0 0 20px rgba(220, 20, 60, 0.8); }
    }
    
    /* VIP ë°°ì§€ - ë ˆë“œ + ê³¨ë“œ */
    .rank-badge.grade-vip { 
      background: linear-gradient(135deg, #dc143c, #8b0000);
      border: 2px solid #ffd700;
      color: #ffd700; 
      text-shadow: 0 1px 3px rgba(0,0,0,0.7);
      animation: vip-glow 1.5s ease-in-out infinite;
    }
    
    .rank-badge.grade-diamond { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #000; }
    .rank-badge.grade-gold { background: linear-gradient(135deg, #ffd700, #cc9900); color: #000; }
    .rank-badge.grade-silver { background: linear-gradient(135deg, #e0e0e0, #a0a0a0); color: #000; }
    .rank-badge.grade-bronze { background: linear-gradient(135deg, #cd7f32, #8b5a2b); color: #fff; }
    
    /* ì˜¨ë¼ì¸ */
    .online-dot {
      position: absolute;
      top: -4px;
      left: -4px;
      width: 12px;
      height: 12px;
      background: #4ade80;
      border-radius: 50%;
      border: 2px solid rgba(15, 10, 25, 0.95);
      box-shadow: 0 0 10px #4ade80;
    }
    
    /* ì»¨íŠ¸ë¡¤ */
    .controls {
      position: fixed;
      bottom: 55px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 50;
    }
    
    .ctrl-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: rgba(15, 10, 25, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ctrl-btn:active { background: rgba(255, 107, 157, 0.3); }
    
    /* ì •ë³´ íŒ¨ë„ */
    .info-panel {
      position: fixed;
      bottom: 55px;
      left: 8px;
      background: rgba(15, 10, 25, 0.95);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 9px;
      z-index: 50;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-item { color: var(--text-muted); }
    .info-item span { color: var(--primary); font-weight: 600; }
    
    /* í•˜ë‹¨ ë„¤ë¹„ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 44px;
      background: rgba(10, 6, 18, 0.98);
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      z-index: 100;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-muted);
      font-size: 8px;
      cursor: pointer;
    }
    
    .nav-item.active { color: var(--primary); }
    .nav-item span:first-child { font-size: 16px; }
    
    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      align-items: flex-end;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: linear-gradient(180deg, #1a1025 0%, #0a0612 100%);
      width: 100%;
      max-height: 70vh;
      border-radius: 14px 14px 0 0;
      padding: 12px 14px 18px;
      animation: slideUp 0.25s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .modal-handle {
      width: 30px;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      margin: 0 auto 10px;
    }
    
    .modal-header {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .modal-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .modal-title { font-size: 16px; font-weight: 700; }
    .modal-meta { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    
    .modal-badges {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    
    .modal-badge {
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 9px;
    }
    
    .modal-badge.rank { background: rgba(255, 215, 0, 0.2); color: var(--gold); }
    .modal-badge.guild { background: rgba(255, 255, 255, 0.1); color: var(--text); }
    
    .modal-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }
    
    .modal-stat {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    
    .modal-stat-value { font-size: 16px; font-weight: 700; color: var(--primary); }
    .modal-stat-label { font-size: 8px; color: var(--text-muted); }
    
    .modal-desc {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: 10px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
      margin-bottom: 10px;
    }
    
    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .modal-btn {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .modal-btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
    }
    
    .modal-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    
    /* ë¡œë”© */
    .loading {
      position: fixed;
      inset: 0;
      background: var(--surface);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      z-index: 9999;
    }
    
    .loading.hidden { display: none; }
    
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255, 107, 157, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .no-results {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text-muted);
    }
    
    .no-results-icon { font-size: 36px; margin-bottom: 8px; }
    .no-results-text { font-size: 11px; }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div style="font-size: 11px; color: var(--text-muted);">í”¼ë¼ë¯¸ë“œ ìƒì„± ì¤‘...</div>
  </div>

  <header class="header">
    <div class="logo">ğŸ”º ê´‘ì¥</div>
    <div class="header-stats">
      <div class="stat-badge">ì „ì²´ <span id="totalCount">0</span></div>
      <div class="stat-badge">í‘œì‹œ <span id="currentCount">0</span></div>
    </div>
  </header>
  
  <div class="filter-section">
    <div class="filter-row">
      <span class="filter-label">ë“±ê¸‰</span>
      <div class="filter-chips" id="gradeFilters"></div>
    </div>
    <div class="filter-row">
      <span class="filter-label">ëª¨ì„</span>
      <div class="filter-chips" id="guildFilters"></div>
    </div>
    <div class="filter-row">
      <span class="filter-label">ë¶„ì•¼</span>
      <div class="filter-chips" id="categoryFilters"></div>
    </div>
  </div>
  
  <div class="map-container" id="mapContainer">
    <div class="map-world" id="mapWorld">
      <div class="pyramid-layer layer-6"></div>
      <div class="pyramid-layer layer-5"></div>
      <div class="pyramid-layer layer-4"></div>
      <div class="pyramid-layer layer-3"></div>
      <div class="pyramid-layer layer-2"></div>
      <div class="pyramid-layer layer-1"></div>
      <div id="shopsContainer"></div>
    </div>
  </div>
  
  <div class="info-panel">
    <div class="info-item">ì¤Œ <span id="zoomLevel">100%</span></div>
  </div>
  
  <div class="controls">
    <button class="ctrl-btn" onclick="zoomIn()">+</button>
    <button class="ctrl-btn" onclick="zoomOut()">âˆ’</button>
    <button class="ctrl-btn" onclick="resetView()">âŒ–</button>
  </div>
  
  <nav class="bottom-nav">
    <div class="nav-item active"><span>ğŸ”º</span><span>í”¼ë¼ë¯¸ë“œ</span></div>
    <div class="nav-item"><span>ğŸ†</span><span>ë­í‚¹</span></div>
    <div class="nav-item"><span>ğŸ”</span><span>ê²€ìƒ‰</span></div>
    <div class="nav-item"><span>ğŸª</span><span>ë‚´ìƒì </span></div>
    <div class="nav-item"><span>ğŸ‘¤</span><span>í”„ë¡œí•„</span></div>
  </nav>
  
  <div class="modal-overlay" id="modal" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-icon" id="modalIcon">ğŸ“¢</div>
        <div style="flex:1">
          <div class="modal-title" id="modalTitle">ì—…ì²´ëª…</div>
          <div class="modal-meta" id="modalMeta">ì¹´í…Œê³ ë¦¬ Â· ë“±ê¸‰</div>
          <div class="modal-badges" id="modalBadges"></div>
        </div>
      </div>
      <div class="modal-stats">
        <div class="modal-stat">
          <div class="modal-stat-value" id="modalScore">0</div>
          <div class="modal-stat-label">ì ìˆ˜</div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-value" id="modalDays">0</div>
          <div class="modal-stat-label">í™œë™ì¼</div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-value" id="modalRef">0</div>
          <div class="modal-stat-label">ë ˆí¼ëŸ´</div>
        </div>
      </div>
      <div class="modal-desc" id="modalDesc">ì—…ì²´ ì†Œê°œ...</div>
      <div class="modal-actions">
        <button class="modal-btn secondary">ğŸ’¬ ë¬¸ì˜</button>
        <button class="modal-btn primary">ğŸ“¢ í™ë³´ê¸€</button>
      </div>
    </div>
  </div>

  <script>
    const CATEGORIES = {
      marketing: { icon: 'ğŸ“¢', name: 'ë§ˆì¼€íŒ…' },
      account: { icon: 'ğŸ‘¤', name: 'ê³„ì •' },
      entertainment: { icon: 'ğŸ°', name: 'ìœ í¥' },
      replica: { icon: 'ğŸ‘œ', name: 'ë ˆí”Œ' },
      document: { icon: 'ğŸ“„', name: 'ë¬¸ì„œ' },
      finance: { icon: 'ğŸ’³', name: 'ê¸ˆìœµ' },
      dev: { icon: 'ğŸ’»', name: 'IT' },
      design: { icon: 'ğŸ¨', name: 'ë””ìì¸' },
      video: { icon: 'ğŸ¬', name: 'ì˜ìƒ' },
      sns: { icon: 'ğŸ“±', name: 'SNS' },
      crypto: { icon: 'â‚¿', name: 'ì½”ì¸' },
      realestate: { icon: 'ğŸ ', name: 'ë¶€ë™ì‚°' },
      car: { icon: 'ğŸš—', name: 'ìë™ì°¨' },
      health: { icon: 'ğŸ’Š', name: 'ê±´ê°•' },
      education: { icon: 'ğŸ“š', name: 'êµìœ¡' },
      travel: { icon: 'âœˆï¸', name: 'ì—¬í–‰' },
      food: { icon: 'ğŸ”', name: 'ìŒì‹' },
      shopping: { icon: 'ğŸ›’', name: 'ì‡¼í•‘' },
      legal: { icon: 'âš–ï¸', name: 'ë²•ë¥ ' },
      security: { icon: 'ğŸ”’', name: 'ë³´ì•ˆ' }
    };
    
    const GRADES = {
      vip: { badge: 'ğŸ‘‘', minScore: 1000, name: 'VIP', color: 'rainbow' },
      diamond: { badge: 'ğŸ’', minScore: 600, name: 'ë‹¤ì´ì•„', color: '#00d4ff' },
      gold: { badge: 'ğŸ¥‡', minScore: 300, name: 'ê³¨ë“œ', color: '#ffd700' },
      silver: { badge: 'ğŸ¥ˆ', minScore: 100, name: 'ì‹¤ë²„', color: '#c0c0c0' },
      bronze: { badge: 'ğŸ¥‰', minScore: 0, name: 'ë¸Œë¡ ì¦ˆ', color: '#cd7f32' }
    };
    
    const GUILDS = {
      blackmarket: { name: 'ë¸”ë™ë§ˆì¼“', icon: 'ğŸ–¤', color: '#333' },
      openmind: { name: 'ì˜¤í”ˆë§ˆì¸ë“œ', icon: 'ğŸ’œ', color: '#9b59b6' },
      sohang: { name: 'ì†Œí–‰', icon: 'â­', color: '#f39c12' },
      phoenix: { name: 'ë¶ˆì‚¬ì¡°', icon: 'ğŸ”¥', color: '#e74c3c' },
      bluemoon: { name: 'ë¸”ë£¨ë¬¸', icon: 'ğŸŒ™', color: '#3498db' },
      greenlight: { name: 'ê·¸ë¦°ë¼ì´íŠ¸', icon: 'ğŸ’š', color: '#2ecc71' },
      redstar: { name: 'ë ˆë“œìŠ¤íƒ€', icon: 'â¤ï¸', color: '#c0392b' },
      goldking: { name: 'ê³¨ë“œí‚¹', icon: 'ğŸ‘‘', color: '#f1c40f' }
    };
    
    const MAP_CENTER = 3000;
    
    // ============================================
    // ìˆœìœ„ë³„ ê²©ì ê°„ê²© (ê²¹ì¹¨ ì™„ì „ ë°©ì§€)
    // ê°„ê²© = ì¹´ë“œí¬ê¸° + ì—¬ë°±
    // ============================================
    const RANK_CONFIG = {
      1:     { size: 120, spacing: 0 },      // ì¤‘ì•™ ê³ ì •
      2:     { size: 100, spacing: 140 },    // 2~3ìœ„
      3:     { size: 100, spacing: 140 },
      10:    { size: 85,  spacing: 115 },    // 4~10ìœ„
      30:    { size: 72,  spacing: 95 },     // 11~30ìœ„
      100:   { size: 60,  spacing: 78 },     // 31~100ìœ„
      9999:  { size: 50,  spacing: 68 }      // 100ìœ„+
    };
    
    function getSpacingForRank(rank) {
      if (rank <= 1) return 0;
      if (rank <= 3) return 140;
      if (rank <= 10) return 115;
      if (rank <= 30) return 95;
      if (rank <= 100) return 78;
      return 68;
    }
    
    function generateCompanies() {
      const companies = [];
      const categoryKeys = Object.keys(CATEGORIES);
      const guildKeys = Object.keys(GUILDS);
      
      const prefixes = ['í”„ë¦¬ë¯¸ì—„', 'ê³¨ë“œ', 'ë‹¤ì´ì•„', 'í”Œë˜í‹°ë„˜', 'ë¡œì–„', 'ì—˜ë¦¬íŠ¸', 'í”„ë¡œ', 'ë§ˆìŠ¤í„°', 'í‚¹', 'ìŠ¤íƒ€', 'íƒ‘', 'ë² ìŠ¤íŠ¸', 'ì›', 'ìŠˆí¼', 'ë©”ê°€', 'ìš¸íŠ¸ë¼', 'ë§¥ìŠ¤', 'í”ŒëŸ¬ìŠ¤', 'í”„ë¼ì„', 'í¼ìŠ¤íŠ¸'];
      const suffixes = ['ì„¼í„°', 'íŒ©í† ë¦¬', 'í´ëŸ½', 'íŒœ', 'í—ˆë¸Œ', 'ë©', 'ê·¸ë£¹', 'ëª°', 'ìƒµ', 'ì¡´'];
      
      let id = 1;
      
      categoryKeys.forEach(category => {
        const count = Math.floor(Math.random() * 12) + 8;
        
        for (let i = 0; i < count; i++) {
          const score = Math.floor(Math.random() * 2000);
          const grade = getGradeByScore(score);
          const name = prefixes[Math.floor(Math.random() * prefixes.length)] + 
                       suffixes[Math.floor(Math.random() * suffixes.length)];
          
          let guilds = [];
          const guildCount = Math.floor(Math.random() * 4);
          const shuffled = [...guildKeys].sort(() => Math.random() - 0.5);
          for (let g = 0; g < guildCount; g++) {
            guilds.push(shuffled[g]);
          }
          
          companies.push({
            id: id++,
            name: name,
            category: category,
            score: score,
            grade: grade,
            guilds: guilds,
            days: Math.floor(Math.random() * 365) + 1,
            referrals: Math.floor(Math.random() * 50),
            online: Math.random() > 0.6,
            description: `${CATEGORIES[category].name} ë¶„ì•¼ ì „ë¬¸. ì‹ ì†í•˜ê³  ì•ˆì „í•œ ì„œë¹„ìŠ¤.`
          });
        }
      });
      
      return companies.sort((a, b) => b.score - a.score);
    }
    
    function getGradeByScore(score) {
      // ì´ì œ ì‚¬ìš© ì•ˆ í•¨ - í¼ì„¼í‹°ì§€ë¡œ ê³„ì‚°
      if (score >= 1000) return 'vip';
      if (score >= 600) return 'diamond';
      if (score >= 300) return 'gold';
      if (score >= 100) return 'silver';
      return 'bronze';
    }
    
    // í¼ì„¼í‹°ì§€ ê¸°ì¤€ ë“±ê¸‰ ê³„ì‚°
    function assignGradesByPercentage(companies) {
      const sorted = [...companies].sort((a, b) => b.score - a.score);
      const total = sorted.length;
      
      sorted.forEach((company, index) => {
        const percentile = (index / total) * 100;
        
        if (percentile < 1) {
          company.grade = 'vip';        // ìƒìœ„ 1%
        } else if (percentile < 5) {
          company.grade = 'diamond';    // ìƒìœ„ 5%
        } else if (percentile < 15) {
          company.grade = 'gold';       // ìƒìœ„ 15%
        } else if (percentile < 40) {
          company.grade = 'silver';     // ìƒìœ„ 40%
        } else {
          company.grade = 'bronze';     // ë‚˜ë¨¸ì§€ 60%
        }
      });
      
      return companies;
    }
    
    // ============================================
    // í”¼ë¼ë¯¸ë“œ ê²©ì ë°°ì¹˜ (ì™„ì „ ê²¹ì¹¨ ë°©ì§€)
    // ============================================
    
    function calculateGridPosition(rank, total) {
      // 1ìœ„ = ì •ì¤‘ì•™
      if (rank === 0) {
        return { x: MAP_CENTER, y: MAP_CENTER };
      }
      
      // í˜„ì¬ ìˆœìœ„ì˜ ê²©ì ê°„ê²©
      const spacing = getSpacingForRank(rank + 1);
      
      // ì–´ëŠ ì¸µ(ring)ì— ìˆëŠ”ì§€ ê³„ì‚°
      const ring = Math.ceil((Math.sqrt(rank + 1) - 1) / 2);
      const ringStart = ring === 0 ? 0 : (2 * ring - 1) * (2 * ring - 1);
      const posInRing = rank - ringStart;
      const sideLength = ring * 2;
      
      // ëˆ„ì  ê±°ë¦¬ ê³„ì‚° (ê° ì¸µì˜ ê°„ê²© í•©ì‚°)
      let accumulatedOffset = 0;
      for (let r = 1; r <= ring; r++) {
        // ê° ì¸µ ì‹œì‘ ìˆœìœ„
        const layerStartRank = r === 1 ? 1 : (2 * (r - 1) - 1) ** 2;
        accumulatedOffset += getSpacingForRank(layerStartRank + 1);
      }
      
      let x, y;
      
      if (posInRing < sideLength) {
        // ìƒë‹¨ (ì¢Œâ†’ìš°)
        x = -accumulatedOffset + posInRing * spacing + spacing / 2;
        y = -accumulatedOffset;
      } else if (posInRing < sideLength * 2) {
        // ìš°ì¸¡ (ìƒâ†’í•˜)
        x = accumulatedOffset;
        y = -accumulatedOffset + (posInRing - sideLength) * spacing + spacing / 2;
      } else if (posInRing < sideLength * 3) {
        // í•˜ë‹¨ (ìš°â†’ì¢Œ)
        x = accumulatedOffset - (posInRing - sideLength * 2) * spacing - spacing / 2;
        y = accumulatedOffset;
      } else {
        // ì¢Œì¸¡ (í•˜â†’ìƒ)
        x = -accumulatedOffset;
        y = accumulatedOffset - (posInRing - sideLength * 3) * spacing - spacing / 2;
      }
      
      return { x: MAP_CENTER + x, y: MAP_CENTER + y };
    }
    
    function getRankClass(rank) {
      if (rank === 1) return 'rank-1';
      if (rank <= 3) return 'rank-2-3';
      if (rank <= 10) return 'rank-4-10';
      if (rank <= 30) return 'rank-11-30';
      if (rank <= 100) return 'rank-31-100';
      return 'rank-100plus';
    }
    
    // ============================================
    // ë Œë”ë§
    // ============================================
    
    let allCompanies = [];
    let displayedCompanies = [];
    let currentFilters = { grade: 'all', guild: 'all', category: 'all' };
    
    function renderFilters() {
      const gradeContainer = document.getElementById('gradeFilters');
      let gradeHtml = `<div class="filter-chip active" data-type="grade" data-value="all">ì „ì²´ <span class="count">${allCompanies.length}</span></div>`;
      Object.entries(GRADES).forEach(([key, grade]) => {
        const count = allCompanies.filter(c => c.grade === key).length;
        gradeHtml += `<div class="filter-chip" data-type="grade" data-value="${key}">${grade.badge}${grade.name} <span class="count">${count}</span></div>`;
      });
      gradeContainer.innerHTML = gradeHtml;
      
      const guildContainer = document.getElementById('guildFilters');
      let guildHtml = `<div class="filter-chip active" data-type="guild" data-value="all">ì „ì²´</div>`;
      Object.entries(GUILDS).forEach(([key, guild]) => {
        const count = allCompanies.filter(c => c.guilds.includes(key)).length;
        guildHtml += `<div class="filter-chip" data-type="guild" data-value="${key}">${guild.icon}${guild.name} <span class="count">${count}</span></div>`;
      });
      const noGuildCount = allCompanies.filter(c => c.guilds.length === 0).length;
      guildHtml += `<div class="filter-chip" data-type="guild" data-value="none">ë¬´ì†Œì† <span class="count">${noGuildCount}</span></div>`;
      guildContainer.innerHTML = guildHtml;
      
      const catContainer = document.getElementById('categoryFilters');
      let catHtml = `<div class="filter-chip active" data-type="category" data-value="all">ì „ì²´</div>`;
      Object.entries(CATEGORIES).forEach(([key, cat]) => {
        const count = allCompanies.filter(c => c.category === key).length;
        catHtml += `<div class="filter-chip" data-type="category" data-value="${key}">${cat.icon}${cat.name} <span class="count">${count}</span></div>`;
      });
      catContainer.innerHTML = catHtml;
      
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
          const type = this.dataset.type;
          const value = this.dataset.value;
          
          document.querySelectorAll(`[data-type="${type}"]`).forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          
          currentFilters[type] = value;
          applyFilters();
        });
      });
    }
    
    function applyFilters() {
      let filtered = [...allCompanies];
      
      if (currentFilters.grade !== 'all') {
        filtered = filtered.filter(c => c.grade === currentFilters.grade);
      }
      
      if (currentFilters.guild !== 'all') {
        if (currentFilters.guild === 'none') {
          filtered = filtered.filter(c => c.guilds.length === 0);
        } else {
          filtered = filtered.filter(c => c.guilds.includes(currentFilters.guild));
        }
      }
      
      if (currentFilters.category !== 'all') {
        filtered = filtered.filter(c => c.category === currentFilters.category);
      }
      
      displayedCompanies = filtered.sort((a, b) => b.score - a.score);
      renderShops(displayedCompanies);
      
      if (currentFilters.grade !== 'all' || currentFilters.guild !== 'all' || currentFilters.category !== 'all') {
        autoZoomToFit(displayedCompanies.length);
      }
    }
    
    function autoZoomToFit(count) {
      if (count === 0) scale = 1;
      else if (count <= 5) scale = 2.0;
      else if (count <= 15) scale = 1.5;
      else if (count <= 40) scale = 1.1;
      else scale = 0.8;
      
      translateX = 0;
      translateY = 0;
      updateTransform();
    }
    
    function renderShops(companies) {
      const container = document.getElementById('shopsContainer');
      container.innerHTML = '';
      
      if (companies.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <div class="no-results-icon">ğŸ”</div>
            <div class="no-results-text">ì¡°ê±´ì— ë§ëŠ” ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        document.getElementById('currentCount').textContent = '0';
        return;
      }
      
      const sorted = [...companies].sort((a, b) => b.score - a.score);
      const totalCount = sorted.length;
      
      sorted.forEach((company, index) => {
        const position = calculateGridPosition(index, totalCount);
        const localRank = index + 1;
        const rankClass = getRankClass(localRank);
        
        // â˜… í•µì‹¬: ìˆœìœ„ ë†’ì„ìˆ˜ë¡ z-index ë†’ê²Œ (1ë“± = ìµœìƒë‹¨)
        const zIndex = totalCount - index + 100;
        
        const shop = document.createElement('div');
        shop.className = `shop ${rankClass} grade-${company.grade}`;
        shop.style.left = `${position.x}px`;
        shop.style.top = `${position.y}px`;
        shop.style.transform = 'translate(-50%, -50%)';
        shop.style.zIndex = zIndex;
        
        // ìˆœìœ„ ë°°ì§€ (ë“±ê¸‰ ìƒ‰ìƒ)
        let rankBadge = '';
        if (localRank <= 50) {
          rankBadge = `<div class="rank-badge grade-${company.grade}">${localRank}</div>`;
        }
        
        // ëª¨ì„ ì•„ì´ì½˜
        let guildIcons = '';
        if (company.guilds.length > 0) {
          guildIcons = '<div class="shop-guilds">';
          company.guilds.slice(0, 3).forEach(guildKey => {
            if (GUILDS[guildKey]) {
              guildIcons += `<span class="shop-guild-icon">${GUILDS[guildKey].icon}</span>`;
            }
          });
          guildIcons += '</div>';
        }
        
        shop.innerHTML = `
          <div class="shop-card">
            ${company.online ? '<div class="online-dot"></div>' : ''}
            ${rankBadge}
            <div class="shop-name">${company.name}</div>
            <div class="shop-score">${GRADES[company.grade].badge} ${company.score.toLocaleString()}</div>
            ${guildIcons}
          </div>
        `;
        
        shop.addEventListener('click', () => openModal(company, localRank));
        container.appendChild(shop);
      });
      
      document.getElementById('totalCount').textContent = allCompanies.length;
      document.getElementById('currentCount').textContent = companies.length;
    }
    
    // ============================================
    // ì¤Œ & íŒ¬
    // ============================================
    
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX, startY;
    
    const mapWorld = document.getElementById('mapWorld');
    const mapContainer = document.getElementById('mapContainer');
    
    function updateTransform() {
      mapWorld.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
      document.getElementById('zoomLevel').textContent = `${Math.round(scale * 100)}%`;
    }
    
    function zoomIn() {
      scale = Math.min(scale + 0.2, 3);
      updateTransform();
    }
    
    function zoomOut() {
      scale = Math.max(scale - 0.2, 0.3);
      updateTransform();
    }
    
    function resetView() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateTransform();
      
      currentFilters = { grade: 'all', guild: 'all', category: 'all' };
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('[data-value="all"]').forEach(c => c.classList.add('active'));
      
      displayedCompanies = [...allCompanies];
      renderShops(displayedCompanies);
    }
    
    mapContainer.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
    });
    
    mapContainer.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
      updateTransform();
    });
    
    mapContainer.addEventListener('mouseup', () => isDragging = false);
    mapContainer.addEventListener('mouseleave', () => isDragging = false);
    
    mapContainer.addEventListener('touchstart', (e) => {
      isDragging = true;
      startX = e.touches[0].clientX - translateX;
      startY = e.touches[0].clientY - translateY;
    });
    
    mapContainer.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      translateX = e.touches[0].clientX - startX;
      translateY = e.touches[0].clientY - startY;
      updateTransform();
    }, { passive: false });
    
    mapContainer.addEventListener('touchend', () => isDragging = false);
    
    mapContainer.addEventListener('wheel', (e) => {
      e.preventDefault();
      if (e.deltaY < 0) zoomIn();
      else zoomOut();
    }, { passive: false });
    
    // ============================================
    // ëª¨ë‹¬
    // ============================================
    
    function openModal(company, rank) {
      document.getElementById('modalIcon').textContent = CATEGORIES[company.category].icon;
      document.getElementById('modalTitle').textContent = company.name;
      document.getElementById('modalMeta').textContent = 
        `${CATEGORIES[company.category].name} Â· ${GRADES[company.grade].badge} ${GRADES[company.grade].name}`;
      document.getElementById('modalScore').textContent = company.score.toLocaleString();
      document.getElementById('modalDays').textContent = company.days;
      document.getElementById('modalRef').textContent = company.referrals;
      document.getElementById('modalDesc').textContent = company.description;
      
      let badgesHtml = `<span class="modal-badge rank">ğŸ† ${rank}ìœ„</span>`;
      company.guilds.forEach(guildKey => {
        if (GUILDS[guildKey]) {
          badgesHtml += `<span class="modal-badge guild">${GUILDS[guildKey].icon} ${GUILDS[guildKey].name}</span>`;
        }
      });
      if (company.guilds.length === 0) {
        badgesHtml += `<span class="modal-badge guild">ë¬´ì†Œì†</span>`;
      }
      document.getElementById('modalBadges').innerHTML = badgesHtml;
      
      document.getElementById('modal').classList.add('active');
    }
    
    function closeModal(e) {
      if (e.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
      }
    }
    
    // ============================================
    // í…”ë ˆê·¸ë¨ ì›¹ì•± ì´ˆê¸°í™”
    // ============================================
    
    let tg = window.Telegram?.WebApp;
    
    if (tg) {
      tg.ready();
      tg.expand(); // ì „ì²´í™”ë©´ìœ¼ë¡œ í™•ì¥
      
      // í…Œë§ˆ ìƒ‰ìƒ ì ìš© (ì„ íƒì‚¬í•­)
      document.body.style.backgroundColor = tg.backgroundColor || '#0a0612';
    }
    
    // ============================================
    // ì´ˆê¸°í™”
    // ============================================
    
    function init() {
      allCompanies = generateCompanies();
      allCompanies = assignGradesByPercentage(allCompanies); // í¼ì„¼í‹°ì§€ ë“±ê¸‰ ì ìš©
      displayedCompanies = [...allCompanies];
      
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
        renderFilters();
        renderShops(displayedCompanies);
      }, 400);
    }
    
    init();
  </script>
</body>
</html>
